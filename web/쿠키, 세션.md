# 쿠키, 세션

## 개요

http 통신은 요청, 응답에 대한 데이터를 저장하지 않고(stateless), 응답 후에는 요청을 끊습니다(connectionless).

그러면 로그인을 할 때 아이디, 비밀번호 등과 같은 정보를 어떻게 저장하고 로그인을 유지해야할까요?

## 1. 쿠키

쿠키는 `key`, `value` 형식으로 클라이언트 로컬에 저장되는 정보입니다.

인증이 유효한 시간을 명시할 수 있어 브라우저가 종료되어도 유효 시간만큼은 쿠키가 유지됩니다.

쿠키가 구워지게 되면 사용자가 따로 설정하지 않아도 Request 헤더에 포함되어 자동으로 서버에 전송됩니다.

### 동작방식
1. 클라이언트가 로그인을 하여 쿠키를 발급받습니다. `set-Cookie:user=dolgodolah`
2. 다음 요청마다 헤더에 쿠키가 포함되어 보내집니다. `Cookie:user=dolgodolah`
3. 서버에서는 쿠키에 있는 사용자정보를 통해 사용자를 식별하고 요청을 처리합니다.

## 2. 세션

쿠키만으로 로그인을 구현하게 되면 사용자 정보가 그대로 노출된다는 치명적인 단점이 있습니다.

이러한 문제는 세션을 통해 해결할 수 있습니다.

사용자가 로그인 요청을 하면

서버에서 식별값(UUID)을 통해 session id를 만들어 `key`, `value` 형식으로 `session id`, `사용자 정보` 세션을 저장합니다.

클라이언트는 session id로 만들어진 JSESSIONID이라는 이름의 쿠키를 발급받게 됩니다.

즉, 클라이언트는 다음 요청부터 `JSESSIONID`, `session id` 형식의 쿠키를 포함시켜 서버에 전송합니다.

중요한 점은 클라이언트와 서버 간에 사용자 정보가 이동하지 않는다는 겁니다.

### 세션 동작방식
1. 클라이언트가 로그인을 하면 `session id`, `사용자 정보` 형식의 세션이 서버에 저장됩니다.
2. 클라이언트는 `JSESSIONID`, `session id` 쿠키를 발급받습니다. `set-Cookie:JSESSIONID=session id`
3. 다음 요청마다 헤더에 쿠키가 포함되어 보내집니다. `Cookie:JSESSIONID=session id`
4. 서버에서는 쿠키에 있는 session id를 통해 세션테이블에 있는 사용자 정보를 찾아 사용자를 식별하고 요청을 처리합니다.

## 3. 세션/쿠키 방식의 로그인

사실상 쿠키만으로 로그인을 구현한다는 것은 보안상 문제가 있기 때문에 불가능한 일이고,

세션을 통해 로그인을 구현한 방식을 세션/쿠키 방식의 로그인이라고 합니다.

최근에는 JWT 방식이 등장했지만 여전히 세션/쿠키 방식의 로그인을 사용하는 서비스가 굉장히 많습니다.

### 3.1 장점

세션을 서버에서 관리하기 때문에 세션 제어가 가능합니다.

악의적으로 사용되고 있는 세션에 대해서 서버에서 삭제하면 됩니다.

이러한 점을 이용해 한 기기에서만 로그인이 가능하도록 하거나, 강제 로그아웃과 같은 사용자의 인증 제어를 할 수 있습니다.

### 3.2 단점

세션을 서버에서 관리한다는 건 그만큼 서버에 부담이 갑니다.

세션 관리에 대해 개발자가 신경 써야할 부분이 생깁니다.

예를 들어 수평적 확장을 하는데 있어 세션 공동 저장소나 클러스터링을 해야하기 때문에 어려움이 있습니다.

