# 쿠키, 세션

## 개요

http 통신은 요청, 응답에 대한 데이터를 저장하지 않고(stateless), 응답 후에는 요청을 끊습니다(connectionless).

그러면 로그인을 할 때 아이디, 비밀번호 등과 같은 정보를 어떻게 저장하고 로그인을 유지해야할까요?

## 1. 쿠키

쿠키는 웹 서버의 역할을 웹 브라우저가 부담함으로써 웹서비스 효율성을 매우 높일 수 있습니다.

쿠키는 `key`, `value` 형식으로 웹 브라우저에 저장되는 정보입니다.

인증이 유효한 시간을 명시할 수 있어 브라우저가 종료되어도 유효 시간만큼은 쿠키가 유지됩니다.

쿠키가 구워지게 되면 사용자가 따로 설정하지 않아도 Request 헤더에 포함되어 자동으로 서버에 전송됩니다.

### 동작방식
1. 클라이언트가 로그인을 하여 쿠키를 발급받습니다. `set-Cookie:user=dolgodolah`
2. 다음 요청마다 헤더에 쿠키가 포함되어 보내집니다. `Cookie:user=dolgodolah`
3. 서버에서는 쿠키에 있는 사용자정보를 통해 사용자를 식별하고 요청을 처리합니다.

## 2. 세션

쿠키만으로 개인식별(로그인)을 구현하게 되면 사용자 정보가 그대로 노출된다는 치명적인 단점이 있습니다.

ssh, ftp, telnet과 같은 연결지향형(connection-oriented)통신은 한번 연결되면 한쪽에서 연결을 끊지 않는 한 서버-클라이언트 서로 간의 식별이 가능한데 이를 세션이라고 합니다.

HTTP에서는 쿠키를 이용하여 이런 세션을 흉내낼 수 있는데 이러한 개인식별자 쿠키를 세션쿠키, 세션ID, 간단히 세션이라고도 부릅니다.

서버에서 식별값(UUID)을 통해 session id를 만들어 `key`, `value` 형식으로 `session id`, `사용자 정보` 세션을 저장합니다.

클라이언트는 session id로 만들어진 JSESSIONID이라는 이름의 쿠키를 발급받게 됩니다. (톰캣 서버 기준)

클라이언트는 다음 요청부터 `JSESSIONID`, `session id` 형식의 쿠키를 헤더에 포함시켜 서버에 전송합니다.

중요한 점은 클라이언트와 서버 간에 사용자 정보가 이동하지 않는다는 겁니다.

## 3. 세션쿠키 방식의 로그인

사실상 쿠키만으로 로그인을 구현한다는 것은 보안상 문제가 있기 때문에 불가능한 일이고,

세션을 통해 로그인을 구현한 방식을 세션쿠키 방식의 로그인이라고 합니다.

### 3.1 동작방식
1. 클라이언트가 로그인을 하면 `session id`, `사용자 정보` 형식의 세션이 서버에 저장됩니다.
2. 클라이언트는 서버로부터 `JSESSIONID`, `session id` 쿠키를 발급받습니다. `set-Cookie:JSESSIONID=session id`
3. 다음 요청마다 헤더에 쿠키가 포함되어 보내집니다. `Cookie:JSESSIONID=session id`
4. 서버에서는 쿠키에 있는 session id를 통해 세션테이블에 있는 사용자 정보를 찾아 사용자를 식별하고 요청을 처리합니다.

최근에는 JWT 방식이 등장했지만 여전히 세션/쿠키 방식의 로그인을 사용하는 서비스가 굉장히 많습니다.

### 3.2 장점

세션을 서버에서 관리하기 때문에 세션 제어가 가능합니다.

악의적으로 사용되고 있는 세션에 대해서 서버에서 삭제하면 됩니다.

이러한 점을 이용해 한 기기에서만 로그인이 가능하도록 하거나, 강제 로그아웃과 같은 사용자의 인증 제어를 할 수 있습니다.

### 3.3 단점

세션을 서버에서 관리한다는 건 그만큼 서버에 부담이 갑니다.

세션 관리에 대해 개발자가 신경 써야할 부분이 생깁니다.

예를 들어 수평적 확장을 하는데 있어 세션 공동 저장소나 클러스터링을 해야하기 때문에 어려움이 있습니다.

## 4. HttpOnly

만약 이 세션쿠키가 탈취당하면 다른 사람이 본인의 권한으로 웹서비스에 접속할 수 있습니다.

HTTP 세션 탈취 공격은 자바스크립트의 실행(XSS)으로 이루어지는데 XSS 취약점이 있는 페이지는 공격자에 의해 웹브라우저에 저장된 쿠키값을 읽히게 됩니다.

이를 방지하기 위해 고안된 세션탈취 방어 방법이 `HttpOnly`입니다.

`HttpOnly`가 설정된 쿠키는 HTTP 통신 상에서만 사용되므로 자바스크립트 같은 외부 프로그램은 접근할 수 없습니다.

```
HTTP/1.1 200 OK
...
Set-Cookie: fr=0KuulGRP9yfrGfPiZ..BYKlaM.Op.AAA.0.0.BYKlaM.AWWPnClQ; expires=Mon, 13-Feb-2017 00:27:56 GMT; Max-Age=7776000; path=/; domain=.facebook.com; httponly
Vary: Accept-Encoding
Content-Type: text/html
X-FB-Debug: te/VbRc/M4/3KICC68vojnxrSDWIGBk1dhCUqZKHGQ7RnHor0Aiw2hUP0FrkeYYt/a9ZMEXQy6ZqFgJNZUA4Qg==
Date: Tue, 15 Nov 2016 00:27:56 GMT
Connection: keep-alive
```

## Reference

[https://webhack.dynu.net/?idx=20161110.002](https://webhack.dynu.net/?idx=20161110.002)